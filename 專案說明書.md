# 寶可夢即時對戰系統 - 完整專案說明書

## 📖 專案概述

這是一個基於網頁的即時多人寶可夢對戰遊戲，支援兩位玩家透過網路進行回合制對戰。遊戲採用復古像素風格，使用 Firebase 實現即時同步，並整合 PokéAPI 取得寶可夢資料。

**開發語言**: JavaScript (Vanilla JS)  
**UI 語言**: 繁體中文  
**後端服務**: Firebase Realtime Database  
**外部 API**: PokéAPI (寶可夢資料)

---

## 🎮 核心功能

### 1. 房間系統
- **建立房間**: 自動生成 6 位數房間代碼
- **加入房間**: 輸入代碼加入對戰
- **狀態顯示**: 即時顯示連線狀態和等待對手訊息

### 2. 隊伍選擇
- 從 30 隻隨機第一世代寶可夢中選擇 4 隻
- 顯示寶可夢圖片、屬性和招式
- 雙方確認後開始對戰

### 3. 回合制戰鬥系統
- **回合計時器**: 每回合 30 秒限時
- **招式選擇**: 每隻寶可夢有 4 個招式
- **傷害計算**: 基於攻擊力、防禦力和屬性相性
- **HP 同步**: 即時更新雙方 HP 狀態
- **寶可夢切換**: 失去戰鬥能力時自動切換下一隻

### 4. 屬性相性系統
根據寶可夢遊戲原理，顯示攻擊效果訊息:
- **效果絕佳！** (傷害 ≥2 倍)
- **有效果！** (傷害 >1 倍但 <2 倍)
- **效果不好...** (傷害 >0 但 <1 倍)
- **沒有效果...** (傷害 = 0)

### 5. 斷線重連系統
- **自動重連**: 頁面重新整理後自動嘗試重連
- **手動重連**: 斷線後可點擊按鈕手動輸入房間代碼重連
- **狀態恢復**: 重連後恢復戰鬥狀態、HP 和活躍寶可夢
- **寬限期**: 對手斷線後給予 60 秒重連時間

### 6. UI/UX 特色
- **即時房間代碼顯示**: 戰鬥中右上角持續顯示房間代碼
- **動態背景**: 根據寶可夢屬性變換戰鬥場景
- **粒子特效**: 攻擊時的屬性粒子效果
- **動畫效果**: 攻擊、受傷、暈眩動畫
- **寶可夢球計數器**: 顯示雙方剩餘寶可夢數量

---

## 🏗️ 技術架構

### 前端結構
```
/Test1
├── index.html          # 主頁面結構
├── style.css           # 樣式表（復古像素風格）
├── script.js           # 遊戲邏輯和 Firebase 整合
├── firebase-config.js  # Firebase 配置 (不應提交到 Git)
├── .gitignore          # Git 忽略檔案
├── README.md           # 專案說明
└── FIREBASE_SETUP.md   # Firebase 設定指南
```

### 資料流架構
```
玩家 1 ←→ Firebase Realtime Database ←→ 玩家 2
         ↓
      PokéAPI (寶可夢資料)
```

### Firebase 資料結構
```javascript
rooms/
  └── {roomCode}/
      ├── host: "player1"
      ├── gameStarted: boolean
      ├── currentTurn: "player1" | "player2"
      ├── player1/
      │   ├── ready: boolean
      │   ├── online: boolean
      │   ├── team: Array<Pokemon>
      │   ├── activePokemon: number
      │   └── currentMove: Move
      └── player2/
          ├── ready: boolean
          ├── online: boolean
          ├── team: Array<Pokemon>
          ├── activePokemon: number
          └── currentMove: Move
```

---

## 💻 核心函式規格

### 1. 房間管理

#### `generateRoomCode()`
```javascript
功能: 生成隨機 6 位數房間代碼
輸入: 無
輸出: String (6位數字)
```

#### `createRoom()`
```javascript
功能: 建立新對戰房間
流程:
  1. 生成房間代碼
  2. 在 Firebase 建立房間節點
  3. 設定玩家角色為 player1
  4. 建立在線狀態監聽
  5. 等待 player2 加入
```

#### `joinRoom(roomCode)`
```javascript
功能: 加入現有房間
輸入: roomCode (String)
流程:
  1. 檢查房間是否存在
  2. 設定玩家角色為 player2
  3. 建立在線狀態監聽
  4. 自動跳轉到隊伍選擇
```

### 2. 遊戲狀態管理

#### `saveGameState()`
```javascript
功能: 儲存遊戲狀態到 localStorage
儲存內容:
  - roomCode
  - playerRole
  - battleStarted
  - timestamp
```

#### `loadGameState()`
```javascript
功能: 從 localStorage 載入遊戲狀態
回傳: Object | null
檢查: 狀態必須在 30 分鐘內
```

#### `attemptReconnect()`
```javascript
功能: 嘗試重新連線到先前的對戰
流程:
  1. 載入已儲存的遊戲狀態
  2. 檢查房間是否仍存在
  3. 恢復在線狀態
  4. 根據 battleStarted 決定跳轉到戰鬥或選隊畫面
輸出: boolean (成功/失敗)
```

### 3. 寶可夢資料

#### `fetchPokemonData(id)`
```javascript
功能: 從 PokéAPI 取得寶可夢完整資料
輸入: id (Number, 1-151)
輸出: Pokemon Object
  {
    id: number,
    name: string (繁體中文),
    sprite: string (圖片 URL),
    types: Array<string>,
    stats: { hp, attack, defense },
    moves: Array<Move>,
    currentHp: number,
    maxHp: number
  }
處理:
  - 取得第五世代動畫圖片
  - 從 species 取得繁體中文名稱
  - 招式也翻譯成繁體中文
```

#### `loadTeamSelection()`
```javascript
功能: 載入隊伍選擇畫面
流程:
  1. 隨機選擇 30 隻第一世代寶可夢
  2. 從 PokéAPI 取得每隻資料
  3. 顯示在選擇網格中
```

### 4. 戰鬥系統

#### `startBattle()`
```javascript
功能: 初始化戰鬥
流程:
  1. 切換到戰鬥畫面
  2. 設定活躍寶可夢 (索引 0)
  3. 根據屬性設定背景
  4. 顯示房間代碼
  5. 建立回合變更監聽器
  6. 建立招式監聽器
  7. 建立 HP 同步監聽器
  8. 建立活躍寶可夢同步監聽器
  9. 開始監控對手斷線
```

#### `executeMove(move, isPlayerAttacking)`
```javascript
功能: 執行招式攻擊
輸入:
  - move: Move 物件 { name, type, power }
  - isPlayerAttacking: boolean
流程:
  1. 顯示攻擊訊息
  2. 播放攻擊動畫
  3. 計算傷害 (含屬性相性)
  4. 顯示效果訊息
  5. 扣除 HP
  6. 同步 HP 到 Firebase
  7. 播放受傷動畫
  8. 檢查是否失去戰鬥能力
  9. 切換回合或處理暈眩
```

#### `calculateEffectiveness(moveType, defenderTypes)`
```javascript
功能: 計算屬性相性
輸入:
  - moveType: string
  - defenderTypes: Array<string>
輸出: {
  multiplier: number,  // 傷害倍率
  message: string      // 效果訊息
}
邏輯:
  - 查詢 typeChart 判斷效果
  - 多個屬性累乘
  - 根據倍率回傳中文訊息
```

#### `handleFaint(isEnemyFainted)`
```javascript
功能: 處理寶可夢失去戰鬥能力
輸入: isEnemyFainted (boolean)
流程:
  1. 顯示暈眩訊息
  2. 更新寶可夢球狀態
  3. 尋找下一隻可用寶可夢
  4. 如無可用: 結束戰鬥
  5. 如有可用: 切換並同步到 Firebase
```

### 5. 同步機制

#### `syncTeamToFirebase()`
```javascript
功能: 同步隊伍狀態到 Firebase
更新內容:
  - 每隻寶可夢的 currentHp
  - 完整的隊伍陣列
用途: 確保對手看到即時 HP 變化
```

#### `monitorOpponentDisconnect(opponentRole)`
```javascript
功能: 監控對手連線狀態
輸入: opponentRole (string)
邏輯:
  - 監聽對手的 online 狀態
  - 離線時啟動 60 秒倒數計時
  - 倒數期間顯示剩餘秒數
  - 60 秒內重連: 取消計時
  - 60 秒後未重連: 結束遊戲
```

### 6. 計時系統

#### `startTimer()`
```javascript
功能: 啟動回合計時器
設定: 30 秒倒數
行為:
  - 每秒更新顯示
  - ≤10 秒: 警告色 (黃色)
  - ≤5 秒: 危險色 (紅色閃爍)
  - 時間到: 自動隨機選擇招式
```

#### `stopTimer()`
```javascript
功能: 停止計時器
用途: 選擇招式後或切換回合時
```

---

## 🎨 UI 元件說明

### 畫面流程
```
房間設定畫面 (room-screen)
    ↓
隊伍選擇畫面 (team-screen)
    ↓
戰鬥畫面 (battle-screen)
    ↓
結果畫面 (result-overlay)
```

### 主要 UI 元件

#### 1. 房間代碼橫幅
```css
位置: 戰鬥畫面右上角
樣式: 黑底金框，顯示當前房間代碼
功能: 方便玩家記住代碼以便重連
```

#### 2. 手動重連按鈕
```css
位置: 戰鬥畫面左下角
樣式: 紫色漸層按鈕
功能: 斷線時手動輸入房間代碼重連
```

#### 3. 寶可夢資訊卡
```
顯示內容:
- 寶可夢名稱 (中文)
- 等級 (固定 Lv.50)
- HP 條 (綠色/黃色/紅色)
- 當前/最大 HP 數值
- 屬性標籤 (中文，帶顏色)
```

#### 4. 招式選單
```
佈局: 2x2 網格
每個按鈕顯示:
- 招式名稱 (中文)
- 招式屬性 (帶顏色標籤)
```

#### 5. 對話框
```
位置: 螢幕下方中央
功能: 顯示戰鬥訊息
特效: 打字機效果
```

---

## 🔧 設定與部署

### Firebase 設定
1. 建立 Firebase 專案
2. 啟用 Realtime Database
3. 複製配置到 `firebase-config.js`
4. 設定安全規則 (見 FIREBASE_SETUP.md)

### 本地執行
```bash
# 使用任何 HTTP 伺服器
# 例如: Live Server (VS Code 擴充)
# 或: python -m http.server 8000
```

### 環境需求
- 現代瀏覽器 (Chrome, Firefox, Edge)
- 網路連線 (Firebase 和 PokéAPI)
- 不需要 Node.js (純前端專案)

---

## 📝 使用流程

### 玩家 1 (房主)
1. 開啟遊戲頁面
2. 點擊「建立房間」
3. 複製並分享房間代碼給對手
4. 等待對手加入
5. 選擇 4 隻寶可夢
6. 點擊「確認隊伍」
7. 等待對手確認
8. 開始對戰

### 玩家 2 (加入者)
1. 開啟遊戲頁面
2. 點擊「加入房間」
3. 輸入房主提供的代碼
4. 點擊「確認」
5. 選擇 4 隻寶可夢
6. 點擊「確認隊伍」
7. 開始對戰

### 對戰中
- 輪到自己時選擇招式 (30 秒限時)
- 觀看攻擊動畫和效果訊息
- 當寶可夢暈眩時自動切換下一隻
- 消滅對手全部寶可夢即獲勝

### 重連流程
**自動重連**:
- 頁面重新整理後自動嘗試重連
- 30 分鐘內有效

**手動重連**:
1. 點擊左下角「斷線重連」按鈕
2. 輸入房間代碼
3. 選擇自己的角色 (玩家1/玩家2)
4. 頁面重新載入並恢復戰鬥

---

## 🐛 已知問題與限制

1. **瀏覽器相容性**: 需支援 ES6+ 語法
2. **網路需求**: Firebase 和 PokéAPI 需穩定網路
3. **同時對戰**: 單一房間代碼僅支援 2 位玩家
4. **中文顯示**: 部分寶可夢或招式可能無中文翻譯
5. **檔案協定**: 需透過 HTTP 伺服器執行 (不支援 file://)

---

## 📚 外部資源

- **Firebase**: https://firebase.google.com/
- **PokéAPI**: https://pokeapi.co/
- **屬性相性**: https://wiki.52poke.com/zh-hant/傷害
- **Google Fonts**: Noto Sans TC (繁體中文字型)

---

## 🎯 未來擴充建議

1. **遊戲功能**:
   - 加入道具系統
   - 支援更多世代寶可夢
   - 排位積分系統
   - 觀戰模式

2. **技術優化**:
   - 加入音效和背景音樂
   - 手機版 RWD 優化
   - 離線模式 (單機 AI)
   - WebSocket 替代 Firebase

3. **社交功能**:
   - 好友系統
   - 對戰紀錄
   - 聊天功能
   - 全域排行榜

---

## 📄 授權說明

本專案為教育與娛樂用途，寶可夢相關資料版權歸任天堂、Game Freak 和 The Pokémon Company 所有。

---

**最後更新**: 2025-11-23  
**版本**: 1.0.0  
**開發者**: [您的名字]  
**聯絡方式**: [您的聯絡資訊]
